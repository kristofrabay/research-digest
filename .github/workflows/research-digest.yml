name: Research Digest Pipeline

on:
  schedule:
    - cron: '0 9,17 * * *'  # 10am and 6pm CET (cron is in UTC)
  workflow_dispatch:  # manual trigger

permissions:
  contents: write

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install uv
          uv sync --frozen
      
      - name: Decode Gmail credentials
        run: |
          echo "${{ secrets.GMAIL_CLIENT_SECRET_B64 }}" | base64 -d > gmail_client_secret.json
          echo "${{ secrets.GMAIL_TOKEN_B64 }}" | base64 -d > gmail_token.json
      
      - name: Run pipeline
        env:
          #PYTHONIOENCODING: utf-8
          #LC_ALL: C.UTF-8
          #LANG: C.UTF-8
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_AGENTS_DISABLE_TRACING: ${{ secrets.OPENAI_AGENTS_DISABLE_TRACING }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          EXA_API_KEY: ${{ secrets.EXA_API_KEY }}
          JINA_API_KEY: ${{ secrets.JINA_API_KEY }}
          VOYAGE_API_KEY: ${{ secrets.VOYAGE_API_KEY }}
          GMAIL_EMAIL_TO: ${{ secrets.GMAIL_EMAIL_TO }}
        run: uv run python scripts/run_pipeline.py
      
      - name: Commit results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/research_items.csv data/content_index.json
          git diff --staged --quiet || git commit -m "Update research digest $(date -u +%Y-%m-%d\ %H:%M) [skip ci]"
          git push